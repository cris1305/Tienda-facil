<div class="min-h-[calc(100vh-64px)] bg-gray-100 flex items-center justify-center p-4">
  <div class="w-full max-w-2xl mx-auto">
    
    @if (isFirstVisit()) {
      <div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg mb-6 shadow-md" role="alert">
        <div class="flex">
          <div class="py-1"><svg class="fill-current h-6 w-6 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 11v4h2v-4H9zm0-4h2v2H9V7z"/></svg></div>
          <div>
            <p class="font-bold text-lg">¡Bienvenido, Vendedor!</p>
            <p class="text-sm">Para empezar, busca y únete a la tienda de tu empleador. Una vez que te unas, tendrás acceso a los productos y herramientas de venta.</p>
          </div>
        </div>
      </div>
    }

    <div class="bg-white p-8 rounded-2xl shadow-xl">
        <div class="text-center">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900">Únete a tu Tienda</h1>
            <p class="mt-2 text-sm text-gray-600">Busca tu tienda por su nombre o por el correo/teléfono del propietario.</p>
        </div>
        
        <!-- Search Form -->
        <form #searchForm="ngForm" (ngSubmit)="searchTiendas()" class="mt-8 flex flex-col sm:flex-row gap-2">
            <input type="text" 
                   name="searchTerm" 
                   class="flex-grow block w-full rounded-md border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-green-600 sm:text-sm"
                   placeholder="Ej: Super Tienda, admin@tienda.com..."
                   [ngModel]="searchTerm()"
                   (ngModelChange)="searchTerm.set($event)">
            <button type="submit" 
                    [disabled]="!searchTerm()"
                    class="bg-green-600 text-white px-6 py-3 rounded-md font-semibold hover:bg-green-700 disabled:bg-green-400 transition flex items-center justify-center gap-2 w-full sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                Buscar
            </button>
        </form>

        <!-- Search Results -->
        <div class="mt-8">
            @if(isLoading()) {
                <p class="text-center text-gray-500">Buscando...</p>
            } @else if(searchResults().length > 0) {
                <ul class="space-y-3">
                    @for(result of searchResults(); track result.tienda.id) {
                        <li class="bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row items-start sm:items-center sm:justify-between gap-4 hover:bg-gray-100 transition">
                            <div class="flex items-center gap-4">
                                <img [src]="result.tienda.image || 'https://picsum.photos/200'" alt="Logo" class="w-12 h-12 rounded-full object-cover">
                                <div>
                                    <p class="font-bold text-lg text-gray-800">{{ result.tienda.name }}</p>
                                    <p class="text-sm text-gray-500">Propietario: {{ result.ownerName }}</p>
                                </div>
                            </div>
                            <button (click)="selectTienda(result.tienda)" class="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 transition text-sm">
                                Unirse
                            </button>
                        </li>
                    }
                </ul>
            } @else {
                 @if(searchForm.submitted) {
                    <p class="text-center text-gray-500 py-4">No se encontraron tiendas con ese criterio de búsqueda.</p>
                 }
            }
        </div>
    </div>
  </div>
</div>

<!-- PIN Entry Modal -->
@if (selectedTienda(); as tienda) {
    <div class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative text-center">
            <h3 class="text-2xl font-bold mb-2">Ingresa el PIN para</h3>
            <p class="text-lg font-semibold text-green-600 mb-6">{{ tienda.name }}</p>
            
            <form #pinForm="ngForm" (ngSubmit)="submitPin(pinForm)">
                <input type="tel"
                       inputmode="numeric"
                       name="pin"
                       required
                       pattern="\d{4}"
                       maxlength="4"
                       ngModel
                       #pinInput="ngModel"
                       class="w-full text-center text-3xl tracking-[1em] font-mono p-3 border-2 rounded-md focus:ring-green-500 focus:border-green-500"
                       [class.border-red-500]="(pinInput.invalid && (pinInput.dirty || pinInput.touched)) || pinError()"
                       [class.border-gray-300]="!((pinInput.invalid && (pinInput.dirty || pinInput.touched)) || pinError())"
                       placeholder="----">

                @if (pinInput.invalid && (pinInput.dirty || pinInput.touched)) {
                    <div class="text-red-600 text-sm mt-2 text-left">
                      @if (pinInput.errors?.['required']) { <p>El PIN es requerido.</p> }
                      @if (pinInput.errors?.['pattern']) { <p>El PIN debe contener exactamente 4 dígitos.</p> }
                    </div>
                }

                @if (pinError()) {
                    <p class="text-red-600 text-sm mt-2">{{ pinError() }}</p>
                }
                
                <div class="mt-6 flex gap-4 justify-center">
                    <button type="button" (click)="cancelPinEntry()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button type="submit" [disabled]="pinForm.invalid" class="px-6 py-2 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition disabled:bg-green-400">
                        Confirmar
                    </button>
                </div>
            </form>

            <button (click)="cancelPinEntry()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>
}